<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Kotlin协程, Change">
    <meta name="description" content="协程（Coroutine）协程引入异步加载图片

普通代码：
  val view = ...
  loadImageAsync(url, callback{
      bitmap -&gt;
      uiThread{
        ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Kotlin协程 | Change</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <link rel="stylesheet" href="/live2d/css/live2d.css">
<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Change</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Change</div>
        <div class="logo-desc">
            
            自强不息，厚德载物
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Kotlin协程
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/kotlin/" target="_blank">
                                <span class="chip bg-color">kotlin</span>
                            </a>
                        
                            <a href="/tags/协程/" target="_blank">
                                <span class="chip bg-color">协程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                Android
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-08-11
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10.4k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        48 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="协程（Coroutine）"><a href="#协程（Coroutine）" class="headerlink" title="协程（Coroutine）"></a>协程（Coroutine）</h1><h2 id="协程引入"><a href="#协程引入" class="headerlink" title="协程引入"></a>协程引入</h2><p>异步加载图片</p>
<ul>
<li><p><strong>普通代码</strong>：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">val</span> view <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token punctuation">{</span>
      bitmap <span class="token operator">-></span>
      uiThread<span class="token punctuation">{</span>
          view<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>  异常捕获：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> view <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token punctuation">{</span>
          <span class="token keyword">fun</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>bitmap<span class="token operator">:</span> Bitmap<span class="token punctuation">)</span><span class="token punctuation">{</span>
              uiThread<span class="token punctuation">{</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                      view<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
                      <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

          <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> Throwable<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p>  &nbsp;</p>
</li>
<li><p><strong>协程代码</strong>：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token function">launch</span><span class="token punctuation">(</span>UI<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">val</span> view <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token keyword">val</span> deferred <span class="token operator">=</span> async <span class="token punctuation">{</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      view<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>deferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p>  异常捕获：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token function">launch</span><span class="token punctuation">(</span>UI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> view <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
          <span class="token keyword">val</span> deferred <span class="token operator">=</span> async <span class="token punctuation">{</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">}</span>
          view<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>deferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>&nbsp;<br>通过上面的例子对比，可以发现使用协程的优点：<br>把异步的代码转换成同步的写法，免除了回调的问题，并且不会阻塞线程；<br>请求结果返回时协程自动帮我们切回到主线程；<br>异常的处理比较简洁，协程内部的异常使用一个try…catch即可捕获；</p>
</li>
</ul>
<h2 id="协程概念"><a href="#协程概念" class="headerlink" title="协程概念"></a>协程概念</h2><p>协程是一种非抢占式或者说协作式的计算机程序并发调度的实现，程序可以主动挂起或者恢复执行。</p>
<p>协程和线程，进程不同，它通常不是由操作系统底层直接支持，而是通过编译器和应用层的库实现。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/kotlin_share_img1.png" alt></p>
<h2 id="Kotlin协程框程架"><a href="#Kotlin协程框程架" class="headerlink" title="Kotlin协程框程架"></a>Kotlin协程框程架</h2><p>协程正式版1.0在Kotlin 1.3 上发布，协程的语言支持与 API 已完全稳定。<br>此后 kotlin 协程不再会被标注为 <strong>experimental</strong>，在 Kotlin 1.3. 之后的版本就可以使用协程代码了。</p>
<h3 id="引入协程库"><a href="#引入协程库" class="headerlink" title="引入协程库"></a>引入协程库</h3><pre class=" language-gradle"><code class="language-gradle">dependencies {
  implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.2.2'
}</code></pre>
<p><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/kotlin_share_img2.png" alt></p>
<h3 id="协程基本术语"><a href="#协程基本术语" class="headerlink" title="协程基本术语"></a>协程基本术语</h3><ul>
<li><strong>协程</strong>（coroutine）<br>可挂起计算的实例。它在概念上类似于线程，在这个意义上，它需要一个代码块运行，并具有类似的生命周期 —— 它可以被创建与启动，但它不绑定到任何特定的线程。<br>它可以在一个线程中挂起其执行，并在另一个线程中恢复。而且，像 <strong>future</strong> 或 <strong>promise</strong> 那样，它在执行结束时可能返回某种结果（值或异常）。<br>&nbsp;</li>
<li><strong>挂起函数</strong>（suspending function）</li>
</ul>
<p><strong>suspend</strong> 修饰符标记的函数。它可能会通过调用其他 <strong>挂起函数</strong> 挂起执行代码，而不阻塞当前执行线程。<br><strong>挂起函数</strong> 不能在常规代码中被调用，只能在其他 <strong>挂起函数</strong> 或 <strong>挂起 lambda 表达式</strong> 中。<br>在 Android Studio 中 <strong>挂起函数</strong> 旁边会有一个特殊的标记符号，告诉开发者这是一个 <strong>挂起函数</strong>。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153302.png" alt><br>&nbsp;</p>
<ul>
<li><strong>挂起 lambda 表达式</strong>（suspending lambda）<br>必须在 <strong>协程</strong> 中运行的代码块。它看起来很像一个普通的 lambda 表达式，但它的函数类型被 <strong>suspend</strong> 修饰符标记。</li>
</ul>
<p><strong>挂起 lambda 表达式</strong> 是 <strong>匿名挂起函数</strong> 的短语法形式。它可能会通过调用其他 <strong>挂起函数</strong> 挂起执行代码，而不阻塞当前执行线程。<br>&nbsp;<br>比如Kotlin协程库的 <strong>launch</strong> 函数的最后一个参数就是 <strong>挂起 lambda 表达式</strong>。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153321.png" alt><br><strong>suspend CoroutineScope.() -&gt; Unit</strong>，这个类型被称之为 <strong>挂起函数类型</strong>。 (suspending function type)</p>
<p>&nbsp;</p>
<ul>
<li><strong>协程构建器</strong>（coroutine builder）<br>使用一些 <strong>挂起 lambda 表达式</strong> 作为参数来创建一个 <strong>协程</strong> 的函数。<br>Kotlin 定义了一些基础的构建 <strong>协程</strong> 的函数，比如 <strong>launch{}</strong>、<strong>future{}</strong> 、 <strong>sequence{}</strong> 等。<br>使用这些基础的 <strong>建构函数</strong> 可以构造其他 <strong>协程</strong> 实例。</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><strong>挂起点</strong>（suspension point）</li>
</ul>
<p><strong>协程</strong> 执行过程中可能被挂起的位置。<br>从语法上说，<strong>挂起点</strong> 是对一个 <strong>挂起函数</strong> 的调用，但实际的挂起在 <strong>挂起函数</strong> 调用了标准库中的原始 <strong>挂起函数</strong> 时发生。<br>&nbsp;</p>
<ul>
<li><strong>续体</strong>（continuation）</li>
</ul>
<p><strong>续体</strong> 是挂起的 <strong>协程</strong> 在 <strong>挂起点</strong> 时的状态。它在概念上代表它在 <strong>挂起点</strong> 之后的剩余应执行的代码。<br>    <code>kotlin
      sequence {
          for (i in 1..10) yield(i * i)
          println(&quot;over&quot;)
      }</code><br>    这里，每次调用挂起函数 yield()时，协程都会挂起，其执行的剩余部分被视作 <strong>续体</strong>。<br>    所以有 10 个续体：循环运行第一次后，i=2，挂起；循环运行第二次后，i=3，挂起……最后一次打印“over”并完结协程。</p>
<h3 id="协程的启动"><a href="#协程的启动" class="headerlink" title="协程的启动"></a>协程的启动</h3><p>1.简单以 <strong>CoroutineScope</strong> 的扩展函数 <strong>launch</strong> 启动一个协程:</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 在后台启动一个新的协程并继续</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 非阻塞的等待 1 秒钟（默认时间单位是毫秒）</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"World!"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 在延迟后打印输出</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello,"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 协程已在等待时主线程还在继续</span>
    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 阻塞主线程 2 秒钟来保证 JVM 存活</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>launch</strong> 函数有三个参数：分别是 <strong>上下文</strong>、<strong>启动模式</strong>、<strong>协程体</strong>。<br><strong>launch</strong> 函数的返回值是 <strong>Job</strong> 类型。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>
    context<span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> EmptyCoroutineContext<span class="token punctuation">,</span>
    start<span class="token operator">:</span> CoroutineStart <span class="token operator">=</span> CoroutineStart<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">,</span>
    block<span class="token operator">:</span> suspend CoroutineScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit
<span class="token punctuation">)</span><span class="token operator">:</span> Job <span class="token punctuation">{</span>
    <span class="token keyword">val</span> newContext <span class="token operator">=</span> <span class="token function">newCoroutineContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token keyword">val</span> coroutine <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">.</span>isLazy<span class="token punctuation">)</span>
        <span class="token function">LazyStandaloneCoroutine</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> block<span class="token punctuation">)</span> <span class="token keyword">else</span>
        <span class="token function">StandaloneCoroutine</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    coroutine<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> coroutine<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
    <span class="token keyword">return</span> coroutine
<span class="token punctuation">}</span></code></pre>
<p>&nbsp;</p>
<ul>
<li><p>参数：上下文<br>上下文，它的接口类型是 <strong>CoroutineContext</strong><br>&nbsp;</p>
</li>
<li><p>参数：启动模式<br>启动模式为 <strong>CoroutineStart</strong> 枚举类型</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token keyword">class</span> CoroutineStart <span class="token punctuation">{</span>
      DEFAULT<span class="token punctuation">,</span>
      LAZY<span class="token punctuation">,</span>
      <span class="token annotation builtin">@ExperimentalCoroutinesApi</span>
      ATOMIC<span class="token punctuation">,</span>
      <span class="token annotation builtin">@ExperimentalCoroutinesApi</span>
      UNDISPATCHED<span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<p>  四个启动模式中，最常用的其实是 <strong>DEFAULT</strong> 和 <strong>LAZY</strong>。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>启动模式</th>
<th>功能特性</th>
</tr>
</thead>
<tbody><tr>
<td>DEFAULT</td>
<td>立即开始执行协程体</td>
</tr>
<tr>
<td>LAZY</td>
<td>只有在需要（start、join、await）时才开始执行</td>
</tr>
<tr>
<td>ATOMIC</td>
<td>立即执行协程体，但在第一个挂起点前不能被取消</td>
</tr>
<tr>
<td>UNDISPATCHED</td>
<td>立即在当前线程执行协程体，直到第一个挂起点（后面取决于调度器）</td>
</tr>
</tbody></table>
<p>&nbsp;</p>
<ul>
<li>参数：协程体<br>协程体为一个 <strong>挂起函数</strong>，类型为<strong>suspend CoroutineScope.() -&gt; Unit</strong>，是个 <strong>挂起lambda表达式</strong>。<br>&nbsp;</li>
<li>返回值：Job</li>
</ul>
<p><strong>CoroutineScope.launch</strong> 函数返回一个 <strong>Job</strong> 对象，该对象代表了这个刚刚创建的 协程实例。<br><strong>Job</strong> 对象有不同的状态（刚创建的状态、活跃的状态、执行完毕的状态、取消状态等）。</p>
<table>
<thead>
<tr>
<th><strong>State</strong></th>
<th>isActive</th>
<th>isCompleted</th>
<th>isCancelled</th>
</tr>
</thead>
<tbody><tr>
<td><em>New</em> (可选的初始状态)</td>
<td><code>false</code></td>
<td><code>false</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td><em>Active</em> (默认的初始状态)</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td><em>Completing</em> (中间状态)</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td><em>Cancelling</em> (中间状态)</td>
<td><code>false</code></td>
<td><code>false</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td><em>Cancelled</em> (最终状态)</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td><em>Completed</em> (最终状态)</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>false</code></td>
</tr>
</tbody></table>
<p>一般而言，<strong>Job</strong> 创建后都处于 <strong>active</strong> 状态，表示这个 <strong>Job</strong> 已经被创建并且被启动了。<br>通过 <strong>协程构建器</strong> 函数的 <strong>start</strong> 参数可以修改这个状态。<br>比如如果使用 <strong>CoroutineStart.LAZY</strong> 作为 <strong>start</strong> 参数，则创建的 <strong>Job</strong> 处于 <strong>new</strong> 状态，<br>这个时候需要通过调用 <strong>Job</strong> 的 <strong>start</strong> 或者 <strong>join</strong> 函数来把该 <strong>Job</strong> 转换为 <strong>active</strong> 状态。</p>
<p>处于 <strong>active</strong> 状态的 <strong>Job</strong> 表示 协程 正在执行。<br>如果执行过程中抛出了异常则会把该 <strong>Job</strong> 标记为 <strong>cancelling</strong> 状态。<br>除此之外，还可以通过调用 <strong>cancel</strong> 函数来把 <strong>Job</strong> 转换为 <strong>cancelling</strong> 状态。<br>然后当 <strong>Job</strong> 完成后就处于 <strong>cancelled</strong> 状态。</p>
<p><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153314.png" alt></p>
<p>具有多个子 <strong>Job</strong> 的父 <strong>Job</strong> 会等待所有子 <strong>job</strong> 完成(或者取消)后，自己才会执行完成。</p>
<p>示例，调用 <strong>cancel</strong> 函数取消协程执行。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//sampleStart</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"job: I'm sleeping <span class="token interpolation variable">$i</span> ..."</span><span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500L</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 延迟一段时间</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main: I'm tired of waiting!"</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 取消该任务</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 等待任务执行结束</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main: Now I can quit."</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//sampleEnd</span>
<span class="token punctuation">}</span></code></pre>
<p>程序执行后的输出：</p>
<pre><code>job: I&#39;m sleeping 0 ...
job: I&#39;m sleeping 1 ...
job: I&#39;m sleeping 2 ...
main: I&#39;m tired of waiting!
main: Now I can quit.</code></pre><p>&nbsp;<br>2.使用 <strong>async</strong> 启动一个协程：<br>在概念上，<strong>async</strong> 就类似于 <strong>launch</strong>。它启动了一个单独的协程，这是一个轻量级的线程并与其它所有的协程一起并发地工作。<br>不同之处在于 <strong>launch</strong> 返回一个<strong>Job</strong> 并且不附带任何结果值，而 <strong>async</strong> 返回一个 <strong>Deferred</strong>。</p>
<p><strong>Deferred</strong> 继承自 <strong>Job</strong>，所以通过 <strong>Deferred</strong> 也可以和 <strong>Job</strong> 一样来控制这个 协程。 </p>
<p><strong>Deferred</strong> 类似于 Java 里面的 <strong>future</strong>，一个轻量级的非阻塞 <strong>future</strong>。<br>通过调用 <strong>Deferred</strong> 对象的 <strong>await()</strong> 函数来等待异步结果的返回。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> one <span class="token operator">=</span> async <span class="token punctuation">{</span> <span class="token function">doSomethingUsefulOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">val</span> two <span class="token operator">=</span> async <span class="token punctuation">{</span> <span class="token function">doSomethingUsefulTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"The answer is <span class="token interpolation"><span class="token delimiter variable">${</span>one<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> two<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

suspend <span class="token keyword">fun</span> <span class="token function">doSomethingUsefulOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">13</span>
<span class="token punctuation">}</span>

suspend <span class="token keyword">fun</span> <span class="token function">doSomethingUsefulTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">29</span>
<span class="token punctuation">}</span></code></pre>
<p>程序执行后的输出：</p>
<pre><code>The answer is 42</code></pre><h3 id="协程的调度"><a href="#协程的调度" class="headerlink" title="协程的调度"></a>协程的调度</h3><p>上面提到协程上下文作为launch函数的参数。</p>
<p><strong>CoroutineContext</strong> 接口的定义：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span><span class="token string">"1.3"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> CoroutineContext <span class="token punctuation">{</span>
    <span class="token keyword">public</span> operator <span class="token keyword">fun</span> <span class="token operator">&lt;</span>E <span class="token operator">:</span> Element<span class="token operator">></span> <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> E<span class="token operator">?</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">fold</span><span class="token punctuation">(</span>initial<span class="token operator">:</span> R<span class="token punctuation">,</span> operation<span class="token operator">:</span> <span class="token punctuation">(</span>R<span class="token punctuation">,</span> Element<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R
    <span class="token keyword">public</span> operator <span class="token keyword">fun</span> <span class="token function">plus</span><span class="token punctuation">(</span>context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">)</span><span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">minusKey</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> CoroutineContext

    <span class="token keyword">public</span> <span class="token keyword">interface</span> Key<span class="token operator">&lt;</span>E <span class="token operator">:</span> Element<span class="token operator">></span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> Element <span class="token operator">:</span> CoroutineContext <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>CoroutineContext</strong> 类似一个集合，它的元素就是源码中看到的 Element。<br>每一个 Element 都有一个 key，因此它可以作为元素出现，同时它也是 CoroutineContext 的子接口，因此也可以作为集合出现。</p>
<p>通常我们见到的上下文的类型是 <strong>CombinedContext</strong> 或者 <strong>EmptyCoroutineContext</strong><br>一个表示上下文的组合，另一个表示什么功能都没有的空的上下文。</p>
<p><strong>CoroutineContext</strong> 有两个非常重要的元素：<strong>Job</strong> 和 <strong>Dispatcher</strong>。<br><strong>Job</strong> 是当前的协程的实例，而 <strong>Dispatcher</strong> 决定了当前协程体执行的线程。</p>
<p>我们在协程体里面访问到的 <strong>coroutineContext</strong> 大多是这个 <strong>CombinedContext</strong> 类型，表示有很多具体的上下文实现的集合。<br>我们如果想要找到某一个特别的上下文实现，就需要用对应的 <strong>Key</strong> 来查找：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>launch
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>ContinuationInterceptor

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span>coroutineContext<span class="token punctuation">[</span>Job<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//StandaloneCoroutine{Active}@4f5a4106</span>
        <span class="token function">println</span><span class="token punctuation">(</span>coroutineContext<span class="token punctuation">[</span>ContinuationInterceptor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//DefaultDispatcher</span>
    <span class="token punctuation">}</span>
    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;<br><strong>Job</strong> 是一个 <strong>CoroutineContext.Element</strong> 的实现，内部有个伴生对象 <strong>Key</strong>；<br>coroutineContext[<strong>Job</strong>] 这里的 <strong>Job</strong> 实际上是对它的伴生对象的引用。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">interface</span> Job <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">Element</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * Key for [Job] instance in the coroutine context.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span>Key<span class="token operator">&lt;</span>Job<span class="token operator">></span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>ContinuationInterceptor</strong> 表示续体拦截器（以下简称拦截器），也是一个 <strong>CoroutineContext.Element</strong> 的实现。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span><span class="token string">"1.3"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> ContinuationInterceptor <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">Element</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * The key that defines *the* context interceptor.
     */</span>    
    <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span>Key<span class="token operator">&lt;</span>ContinuationInterceptor<span class="token operator">></span>

    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">interceptContinuation</span><span class="token punctuation">(</span>continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<p>拦截器可以左右你的协程的执行。</p>
<p>以下是自定义拦截器的例子。让协程代码块运行在自定义的线程中。</p>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> job<span class="token operator">:</span> Job <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token function">MyContinuationInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        launch <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MyContinuationInterceptor <span class="token operator">:</span> ContinuationInterceptor <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key <span class="token operator">=</span> ContinuationInterceptor

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">interceptContinuation</span><span class="token punctuation">(</span>continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">MyContinuation</span><span class="token punctuation">(</span>continuation<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MyContinuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">val</span> continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> context<span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> continuation<span class="token punctuation">.</span>context

    <span class="token keyword">private</span> <span class="token keyword">val</span> executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span> <span class="token punctuation">{</span>
        <span class="token function">Thread</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token string">"MyThreadExecutor"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>isDaemon <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">resumeWith</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//切换线程（模拟简单的协程调度器）</span>
            continuation<span class="token punctuation">.</span><span class="token function">resumeWith</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>所有协程启动的时候，都会有一次 Continuation.resumeWith 的操作。<br>对于受MyContinuationInterceptor影响的协程启动时，都会执行MyContinuation.resumeWith<br>delay 是挂起点，1000ms 之后需要继续调度执行该协程，也会执行MyContinuation.resumeWith</p>
<pre><code>18:01:41:337 [main] MyContinuation.resumeWith(ConsoleMain3.kt:46): Success(kotlin.Unit)  // ①
18:01:41:358 [MyThreadExecutor] ConsoleMain3Kt$main$job$1.invokeSuspend(ConsoleMain3.kt:20): 1
18:01:42:371 [kotlinx.coroutines.DefaultExecutor] MyContinuation.resumeWith(ConsoleMain3.kt:46): Success(kotlin.Unit)  // ②
18:01:42:372 [MyThreadExecutor] ConsoleMain3Kt$main$job$1.invokeSuspend(ConsoleMain3.kt:22): 2
18:01:42:375 [MyThreadExecutor] MyContinuation.resumeWith(ConsoleMain3.kt:46): Success(kotlin.Unit)  // ③
18:01:42:376 [MyThreadExecutor] ConsoleMain3Kt$main$job$1$1.invokeSuspend(ConsoleMain3.kt:24): 3</code></pre><p>&nbsp;</p>
<p>Kotlin协程库中有专门的拦截器的实现，叫做 <strong>CoroutineDispatcher</strong>（协程调度器，以下简称调度器）<br>它确定了相应的协程在执行时使用哪些线程。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> CoroutineDispatcher <span class="token operator">:</span>
    <span class="token function">AbstractCoroutineContextElement</span><span class="token punctuation">(</span>ContinuationInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span> ContinuationInterceptor <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span> block<span class="token operator">:</span> Runnable<span class="token punctuation">)</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<p>它本身是协程上下文的子类，同时实现了拦截器的接口， dispatch 方法会在拦截器的方法 interceptContinuation 中调用，进而实现协程的调度。<br>所以如果我们想要实现自己的调度器，继承这个类就可以了。<br>不过通常我们都用协程框架提供的，它们定义在 Dispatchers 当中：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> actual <span class="token keyword">object</span> Dispatchers <span class="token punctuation">{</span>
    <span class="token annotation builtin">@JvmStatic</span>
    <span class="token keyword">public</span> actual <span class="token keyword">val</span> Default<span class="token operator">:</span> CoroutineDispatcher <span class="token operator">=</span> <span class="token function">createDefaultDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token annotation builtin">@JvmStatic</span>
    <span class="token keyword">public</span> actual <span class="token keyword">val</span> Main<span class="token operator">:</span> MainCoroutineDispatcher <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> MainDispatcherLoader<span class="token punctuation">.</span>dispatcher

    <span class="token annotation builtin">@JvmStatic</span>
    <span class="token keyword">public</span> actual <span class="token keyword">val</span> Unconfined<span class="token operator">:</span> CoroutineDispatcher <span class="token operator">=</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>Unconfined

    <span class="token annotation builtin">@JvmStatic</span>
    <span class="token keyword">public</span> <span class="token keyword">val</span> IO<span class="token operator">:</span> CoroutineDispatcher <span class="token operator">=</span> DefaultScheduler<span class="token punctuation">.</span>IO
<span class="token punctuation">}</span>
</code></pre>
<table>
<thead>
<tr>
<th>调度器</th>
<th>JVM</th>
</tr>
</thead>
<tbody><tr>
<td>Default</td>
<td>线程池</td>
</tr>
<tr>
<td>Main</td>
<td>UI线程</td>
</tr>
<tr>
<td>Unconfined</td>
<td>直接执行，直到遇到第一个挂起点</td>
</tr>
<tr>
<td>IO</td>
<td>线程池</td>
</tr>
</tbody></table>
<p>指定调度器启动协程：</p>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/** Dispatchers.Default **/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>GlobalScope.launch</strong> 默认使用 <strong>DefaultDispatcher</strong> 调度任务。<br><strong>Dispatchers.Main</strong> 来确保 <strong>launch</strong> 启动的协程在调度时始终调度到 UI 线程。<br>在 Android 当中，<strong>Dispatchers.Main</strong> 引用的实例是 <strong>HandlerDispatcher</strong> 。</p>
<p>执行结果如下：</p>
<pre><code>19:07:31:494 [DefaultDispatcher-worker-1] DispatchKt$main$2.invokeSuspend(Dispatch.kt:23): 1
19:07:31:591 [AWT-EventQueue-0] DispatchKt$main$2$1.invokeSuspend(Dispatch.kt:25): 2</code></pre><p>&nbsp;<br>其他创建调度器的方式：</p>
<ul>
<li><strong>newSingleThreadContext</strong> 创建线程池中只有一个线程的Dispatcher，使用完毕后需要close。</li>
<li><strong>newFixedThreadPoolContext</strong> 创建在私有的线程池中运行的 Dispatcher，使用完毕后需要close。</li>
<li><strong>Executor.asCoroutineDispatcher</strong>  把Executor 对象转换为一个 Dispatcher 使用。</li>
</ul>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span> <span class="token punctuation">{</span> r <span class="token operator">-></span> <span class="token function">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"MyThread"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">asCoroutineDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span> dispatcher <span class="token operator">-></span>
            GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果：</p>
<pre><code>19:01:36:027 [MyThread] DispatchKt$main$3$1.invokeSuspend(Dispatch.kt:13): 1
19:01:36:051 [MyThread] DispatchKt.main(Dispatch.kt:16): 2</code></pre><h3 id="协程的异常处理"><a href="#协程的异常处理" class="headerlink" title="协程的异常处理"></a>协程的异常处理</h3><p>通过一个在 <strong>GlobalScope</strong> 中创建协程的示例来看一下协程的异常处理，中间添加了异常捕获。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"launch new coroutine"</span><span class="token punctuation">)</span>
            launch <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Throwing exception from launch"</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Caught launch Exception: <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//①</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Joined failed job"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> deferred <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">async</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Throwing exception from async"</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">ArithmeticException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有打印任何东西，依赖用户去调用等待</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        deferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unreached"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> ArithmeticException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Caught ArithmeticException"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//②</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>输出结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">16</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">654</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">:</span> launch new coroutine
<span class="token number">16</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">671</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token operator">:</span> Throwing exception from launch
Exception <span class="token keyword">in</span> thread <span class="token string">"DefaultDispatcher-worker-1 @coroutine#3"</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
    at com<span class="token punctuation">.</span>coroutine<span class="token punctuation">.</span>console<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>
    at kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>BaseContinuationImpl<span class="token punctuation">.</span><span class="token function">resumeWith</span><span class="token punctuation">(</span>ContinuationImpl<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>DispatchedTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Dispatched<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">238</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span><span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">594</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span>access$<span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler$Worker<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">742</span><span class="token punctuation">)</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">678</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token operator">:</span> Joined failed job
<span class="token number">16</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">680</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">4</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$deferred$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> Throwing exception from async
<span class="token number">16</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">712</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token operator">:</span> Caught ArithmeticException</code></pre>
<p>从上面的输出的log，会发现并没有捕获到①处的异常。②处的异常却被捕获到了。</p>
<p>不同的协程构建器函数有不同的异常传递策略，在协程中异常传递分为两种类型。<br>一种是自动向上传递（<strong>launch</strong> 和 <strong>actor</strong>），另外一种是把错误信息暴露给调用者（<strong>async</strong> 和 <strong>produce</strong>）。<br>前者对待异常是不处理的，类似于 Java 的 <strong>Thread.uncaughtExceptionHandler</strong> ，而后者依赖调用者来最终处理异常。</p>
<p>如果把代码改写成以下就可以捕获到异常：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

    <span class="token keyword">val</span> handler <span class="token operator">=</span> CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> exception <span class="token operator">-></span>
        Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$exception</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> job <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"launch new coroutine"</span><span class="token punctuation">)</span>
        launch <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Throwing exception from launch"</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Joined failed job"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> deferred <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">async</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Throwing exception from async"</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">ArithmeticException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有打印任何东西，依赖用户去调用等待</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        deferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unreached"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> ArithmeticException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Caught ArithmeticException"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//②</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">861</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">:</span> launch new coroutine
<span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">877</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> Throwing exception from launch
<span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">881</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$invokeSuspend$$inlined$CoroutineExceptionHandler$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">handleException</span><span class="token punctuation">(</span>CoroutineExceptionHandler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span><span class="token operator">:</span> Caught java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
<span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">882</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">:</span> Joined failed job
<span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">883</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">4</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$deferred$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token operator">:</span> Throwing exception from async
<span class="token number">16</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">915</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">:</span> Caught ArithmeticException</code></pre>
<p>&nbsp;<br><strong>CoroutineExceptionHandler</strong><br>对于通过 <strong>launch</strong> 和 <strong>actor</strong> 构建器创建的协程，如果里面抛出了异常需要通过 <strong>CoroutineExceptionHandler</strong> 来捕获异常。<br><strong>CoroutineExceptionHandler</strong> 类似于 <strong>Thread.uncaughtExceptionHandler</strong> 全局异常处理。<br><strong>CoroutineExceptionHandler</strong> 并不算是一个全局的异常捕获，因为它只能捕获对应协程内未捕获的异常。</p>
<p>从上面代码看到 <strong>CoroutineExceptionHandler</strong> 可以作为 <strong>launch</strong> 函数的参数，也能猜到其类型属于 <strong>CoroutineContext</strong>。</p>
<p><strong>CoroutineExceptionHandler</strong> 接口定义：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">interface</span> CoroutineExceptionHandler <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">Element</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * Key for [CoroutineExceptionHandler] instance in the coroutine context.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span> CoroutineContext<span class="token punctuation">.</span>Key<span class="token operator">&lt;</span>CoroutineExceptionHandler<span class="token operator">></span>

    <span class="token comment" spellcheck="true">/**
     * Handles uncaught [exception] in the given [context]. It is invoked
     * if coroutine has an uncaught exception.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">handleException</span><span class="token punctuation">(</span>context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span> exception<span class="token operator">:</span> Throwable<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>&nbsp;<br><strong>异常的传播</strong></p>
<p>异常传播还涉及到 <strong>CoroutineScope</strong> （协程作用域，以下简称作用域）的概念。</p>
<p><strong>CoroutineScope</strong>接口的定义：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">interface</span> CoroutineScope <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">val</span> coroutineContext<span class="token operator">:</span> CoroutineContext
<span class="token punctuation">}</span></code></pre>
<p><strong>CoroutineScope</strong>  是 <strong>kotlinx.coroutines</strong> 提供的一个抽象的封装，用来管理协程的生命周期。</p>
<p>比如：<br>在Android程序在上下文中启动了多个协程来为某个activity 进行异步操作来拉取以及更新数据，或作动画等。<br>当 activity 被销毁的时候这些协程必须被取消以防止内存泄漏。就需要用到 <strong>CoroutineScope</strong>，<br>这样当这个 <strong>CoroutineScope</strong> 被取消的时候，里面所有的子协程也会自动取消。</p>
<p>每个协程构建器都是 <strong>CoroutineScope</strong> 的扩展函数，并且自动的继承了当前作用域的 <strong>coroutineContext</strong>。<br>所以要使用协程必须要先创建一个对应的 <strong>CoroutineScope</strong>。</p>
<p>协程执行代码块的 <strong>this</strong> 字段就代表了当前使用的 <strong>CoroutineScope</strong> 实例。<br>所以就能够在其内部继续启动子协程，比如下面的嵌套的 <strong>launch</strong><br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153317.png" alt></p>
<ul>
<li><p>取消与异常<br>取消与异常紧密相关。协程内部使用 <strong>CancellationException</strong> 来进行取消。<br>这个异常会被所有的处理者忽略，所以那些可以被 catch 代码块捕获的异常 仅仅应该被用来作为额外调试信息的资源。<br>例子1：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

      <span class="token keyword">val</span> job1 <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> job2 <span class="token operator">=</span> launch <span class="token punctuation">{</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
              <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              job2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
              Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Caught exception: <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      job1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p>  子协程launch抛出异常之后，会把父协程给cancel掉了。<br>  父协程已经被cancel，如果再调用 job2.join 就会抛出 <strong>JobCancellationException</strong>。<br>  &nbsp;<br>  运行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">17</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">135</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token number">17</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">151</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span>$job2$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token number">17</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">172</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span> Caught exception<span class="token operator">:</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>JobCancellationException<span class="token operator">:</span> StandaloneCoroutine <span class="token keyword">is</span> cancelling<span class="token punctuation">;</span> job<span class="token operator">=</span><span class="token string">"coroutine#2"</span><span class="token operator">:</span>StandaloneCoroutine<span class="token punctuation">{</span>Cancelling<span class="token punctuation">}</span><span class="token label symbol">@31498115</span>
  Exception <span class="token keyword">in</span> thread <span class="token string">"DefaultDispatcher-worker-1 @coroutine#2"</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
      at com<span class="token punctuation">.</span>coroutine<span class="token punctuation">.</span>console<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span>$job2$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
      at kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>BaseContinuationImpl<span class="token punctuation">.</span><span class="token function">resumeWith</span><span class="token punctuation">(</span>ContinuationImpl<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>DispatchedTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Dispatched<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">238</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span><span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">594</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span>access$<span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler$Worker<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">742</span><span class="token punctuation">)</span>
  <span class="token number">17</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">179</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span></code></pre>
<p>  上面例子也说明了异常的传播方向，子协程会把异常传给了父协程，导致父协程被取消。<br>  &nbsp;<br>  例子2：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

      <span class="token keyword">val</span> job1 <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> exception <span class="token operator">-></span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"#1 Caught <span class="token interpolation variable">$exception</span>"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//①</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> job2 <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> exception <span class="token operator">-></span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"#2 Caught <span class="token interpolation variable">$exception</span>"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//②</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
              <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          job2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      job1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p>  从运行结果来看，②处并没有输出异常信息，①处输出了异常信息。再次证明了子协程会把异常传给了父协程。</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">18</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">688</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token number">18</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">706</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span>$job2$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token number">18</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">726</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$invokeSuspend$$inlined$CoroutineExceptionHandler$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">handleException</span><span class="token punctuation">(</span>CoroutineExceptionHandler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span><span class="token operator">:</span> #<span class="token number">1</span> Caught java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
  <span class="token number">18</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">727</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span></code></pre>
<p>  &nbsp;<br>  例子3：<br>  父协程遇到异常也会把子协程给取消掉。取消异常向下传播</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

      <span class="token keyword">val</span> job1 <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
          launch <span class="token punctuation">{</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
              <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      job1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p> 运行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">18</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">788</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token number">18</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">806</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">2</span>
  Exception <span class="token keyword">in</span> thread <span class="token string">"DefaultDispatcher-worker-3 @coroutine#3"</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
      at com<span class="token punctuation">.</span>coroutine<span class="token punctuation">.</span>console<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">)</span>
      at kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>BaseContinuationImpl<span class="token punctuation">.</span><span class="token function">resumeWith</span><span class="token punctuation">(</span>ContinuationImpl<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>DispatchedTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Dispatched<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">238</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span><span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">594</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler<span class="token punctuation">.</span>access$<span class="token function">runSafely</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>
      at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>CoroutineScheduler$Worker<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>CoroutineScheduler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">742</span><span class="token punctuation">)</span>
  <span class="token number">18</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">856</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span></code></pre>
<p>  上面的例子取消都是双向的：<br>  取消父任务会同时取消所有子任务，而某一个子任务出现的异常被取消，则会导致父任务和所有其他子任务也被同时取消。<br>  &nbsp;<br>  还有一种情况，取消是单向的。这种需求很常见。<br>  比如在Android应用中，打开一个界面，在这个Activity 的作用域内启动了多个任务加载不同的数据，<br>  而这些加载不同数据的子任务是相互独立的，某一个失败了不应该影响其他子任务的执行；<br>  而如果这个 Activity 退出被销毁了，则所有请求数据的子任务就没有必要了，需要被取消。<br>  这种行为可以通过 <strong>SupervisorJob</strong>（监督任务）来实现。<br>  &nbsp;<br>  <strong>SupervisorJob</strong> 它类似于常规的 <strong>Job</strong>，唯一的区别是 <strong>取消</strong> 只会向下传播。<br>  &nbsp;<br>  示例：<br>  子任务失败，不会取消其他子任务，也不会取消父任务。而父任务能够取消所有子任务的执行。</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
      <span class="token keyword">val</span> supervisor <span class="token operator">=</span> <span class="token function">SupervisorJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">with</span><span class="token punctuation">(</span><span class="token function">CoroutineScope</span><span class="token punctuation">(</span>coroutineContext <span class="token operator">+</span> supervisor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// 启动第一个子任务</span>
          <span class="token keyword">val</span> firstChild <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> _ <span class="token operator">-></span>  Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Caught Exception"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"First child is failing"</span><span class="token punctuation">)</span>
              <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string">"First child is cancelled"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">// 启动第二个子任务</span>
          <span class="token keyword">val</span> secondChild <span class="token operator">=</span> launch <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// 取消了第一个子任务且没有传播给第二个子任务</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"First child is cancelled: <span class="token interpolation"><span class="token delimiter variable">${</span>firstChild<span class="token punctuation">.</span>isCancelled<span class="token delimiter variable">}</span></span>, but second one is still active"</span><span class="token punctuation">)</span>
              <span class="token keyword">try</span> <span class="token punctuation">{</span>
                  <span class="token function">delay</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span>
              <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// 但是取消了监督的传播</span>
                  Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Second child is cancelled because supervisor is cancelled"</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">// 等待直到第一个子任务失败且执行完成</span>
          firstChild<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Cancelling supervisor"</span><span class="token punctuation">)</span>
          supervisor<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          secondChild<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>  执行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">20</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">828</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span>$firstChild$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token operator">:</span> First child <span class="token keyword">is</span> failing
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">838</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$$special$$inlined$CoroutineExceptionHandler$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">handleException</span><span class="token punctuation">(</span>CoroutineExceptionHandler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span><span class="token operator">:</span> Caught Exception
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">839</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span>$secondChild$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token operator">:</span> First child <span class="token keyword">is</span> cancelled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> but second one <span class="token keyword">is</span> still active
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">842</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token operator">:</span> Cancelling supervisor
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">864</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span>$secondChild$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> Second child <span class="token keyword">is</span> cancelled because supervisor <span class="token keyword">is</span> cancelled</code></pre>
<p>  &nbsp;<br>  <strong>supervisorScope</strong><br>  除了使用 <strong>SupervisorJob</strong>，也可以使用<strong>supervisorScope</strong>代替<strong>coroutineScope</strong>来实现相同的目的。<br>  它与 <strong>coroutineScope</strong> 的差异在于，它仅<strong>单向</strong>上传播 <strong>取消</strong>，并且只有在自身失败时才取消所有孩子。<br>  另外，子任务的执行失败不会传播给它的父任务。每一个子任务应该通过异常处理机制处理自身的异常。<br>  &nbsp;<br>  示例：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

      <span class="token keyword">val</span> job1 <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> exception <span class="token operator">-></span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"#1 Caught <span class="token interpolation variable">$exception</span>"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//①</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
          supervisorScope <span class="token punctuation">{</span>
              <span class="token function">launch</span><span class="token punctuation">(</span>CoroutineExceptionHandler <span class="token punctuation">{</span> _<span class="token punctuation">,</span> exception <span class="token operator">-></span>
                  Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"#2 Caught <span class="token interpolation variable">$exception</span>"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//②</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
                  <span class="token keyword">throw</span> <span class="token function">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
              launch <span class="token punctuation">{</span>
                  Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      job1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre>
<p>  运行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">322</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">347</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span>$<span class="token number">1</span>$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">348</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">3</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span>$<span class="token number">1</span>$invokeSuspend$$inlined$CoroutineExceptionHandler$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">handleException</span><span class="token punctuation">(</span>CoroutineExceptionHandler<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span><span class="token operator">:</span> #<span class="token number">2</span> Caught java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">349</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">350</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">4</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">2</span>$<span class="token number">1</span>$<span class="token number">3</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span></code></pre>
<p>&nbsp;<br>总结：</p>
</li>
<li><p><strong>GlobeScope</strong> 启动的协程单独启动一个协程作用域，异常自己消化，不向外部传播。内部的子协程遵从默认的作用域规则。</p>
</li>
<li><p><strong>coroutineScope</strong> 是继承外部 Job 的上下文创建作用域，在其内部的取消操作是双向传播的，子协程未捕获的异常也会向上传递给父协程。它更适合一系列对等的协程并发的完成一项工作，任何一个子协程异常退出，那么整体都将退出。</p>
</li>
<li><p><strong>supervisorScope</strong> 同样继承外部作用域的上下文创建作用域，但其内部的取消操作是单向传播的，父协程向子协程传播，反之则不然，这意味着子协程出了异常并不会影响父协程以及其他兄弟协程。它更适合一些独立不相干的任务，任何一个任务出问题，并不会影响其他任务的工作。</p>
</li>
</ul>
<h3 id="协程的取消"><a href="#协程的取消" class="headerlink" title="协程的取消"></a>协程的取消</h3><p><strong>取消是协作的</strong></p>
<p>协程的取消是 协作 的。一段协程代码必须协作才能被取消。<br>所有 <strong>kotlinx.coroutines</strong> 中的挂起函数都是 可被取消的。<br>它们检查协程的取消， 并在取消时抛出 <strong>CancellationException</strong> 。<br>&nbsp;<br>示例：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword">val</span> job1 <span class="token operator">=</span> launch <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ①</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ②</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    job1<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ③</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>执行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">14</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">604</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token number">14</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">645</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token number">14</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">647</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span></code></pre>
<p>程序分析：<br>这段代码 ① 处启动了一个子协程，它内部先输出 1，接着开始 delay， delay 与线程的 sleep 不同，它不会阻塞线程。<br>你可以认为它实际上就是触发了一个延时任务，告诉协程调度系统 1000ms 之后再来执行后面的代码；</p>
<p>而在这期间，我们在 ③ 处对刚才启动的协程触发了取消，因此在 ② 处的 delay 还没有回调的时候协程就被取消了。<br>因为 delay 可以响应取消，因此 delay 后面的代码就不会再执行了，因为② 处的 delay 会抛一个 <strong>CancellationException</strong>。<br>&nbsp;<br>下面来捕获一下这个Exception：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword">val</span> job1 <span class="token operator">=</span> launch <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ①</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ②</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    job1<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ③</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">15</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">924</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">926</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">4</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">943</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>JobCancellationException<span class="token operator">:</span> Job was cancelled<span class="token punctuation">;</span> job<span class="token operator">=</span><span class="token string">"coroutine#2"</span><span class="token operator">:</span>StandaloneCoroutine<span class="token punctuation">{</span>Cancelling<span class="token punctuation">}</span><span class="token label symbol">@2be94b0f</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">943</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job1$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">2</span></code></pre>
<p>&nbsp;<br>如果协程正在执行 计算任务，并且没有检查取消的话，那么它是不能被取消的。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//sampleStart</span>
    <span class="token keyword">val</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nextPrintTime <span class="token operator">=</span> startTime
        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 一个执行计算的循环，只是为了占用 CPU</span>
            <span class="token comment" spellcheck="true">// 每秒打印消息两次</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> nextPrintTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"job: I'm sleeping <span class="token interpolation"><span class="token delimiter variable">${</span>i<span class="token operator">++</span><span class="token delimiter variable">}</span></span> ..."</span><span class="token punctuation">)</span>
                nextPrintTime <span class="token operator">+=</span> <span class="token number">500L</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 等待一段时间</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: I'm tired of waiting!"</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 取消一个任务并且等待它结束</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: Now I can quit."</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sampleEnd</span>
<span class="token punctuation">}</span></code></pre>
<p>输出结果：</p>
<pre><code>15:21:11:418 [DefaultDispatcher-worker-2 @coroutine#2] ConsoleExceptionDemoKt$main$1$job$1.invokeSuspend(ConsoleExceptionDemo.kt:16): job: I&#39;m sleeping 0 ...
15:21:11:856 [DefaultDispatcher-worker-2 @coroutine#2] ConsoleExceptionDemoKt$main$1$job$1.invokeSuspend(ConsoleExceptionDemo.kt:16): job: I&#39;m sleeping 1 ...
15:21:12:356 [DefaultDispatcher-worker-2 @coroutine#2] ConsoleExceptionDemoKt$main$1$job$1.invokeSuspend(ConsoleExceptionDemo.kt:16): job: I&#39;m sleeping 2 ...
15:21:12:665 [main @coroutine#1] ConsoleExceptionDemoKt$main$1.invokeSuspend(ConsoleExceptionDemo.kt:22): main: I&#39;m tired of waiting!
15:21:12:856 [DefaultDispatcher-worker-2 @coroutine#2] ConsoleExceptionDemoKt$main$1$job$1.invokeSuspend(ConsoleExceptionDemo.kt:16): job: I&#39;m sleeping 3 ...
15:21:13:356 [DefaultDispatcher-worker-2 @coroutine#2] ConsoleExceptionDemoKt$main$1$job$1.invokeSuspend(ConsoleExceptionDemo.kt:16): job: I&#39;m sleeping 4 ...
15:21:13:357 [main @coroutine#1] ConsoleExceptionDemoKt$main$1.invokeSuspend(ConsoleExceptionDemo.kt:24): main: Now I can quit.</code></pre><p>可以看到它连续打印出了“I’m sleeping” ，甚至在调用取消后， 任务仍然执行了五次循环迭代并运行到了它结束为止。<br>&nbsp;<br><strong>使计算代码可取消</strong></p>
<p>我们有两种方法来使执行计算的代码可以被取消。<br>第一种方法是定期调用挂起函数来检查取消。对于这种目的，使用 <strong>yield</strong> 是一个好的选择。<br>另一种方法是显式的检查取消状态。让我们试下第二种方法。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//sampleStart</span>
    <span class="token keyword">val</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nextPrintTime <span class="token operator">=</span> startTime
        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 可以被取消的计算循环</span>
            <span class="token comment" spellcheck="true">// 每秒打印消息两次</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> nextPrintTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"job: I'm sleeping <span class="token interpolation"><span class="token delimiter variable">${</span>i<span class="token operator">++</span><span class="token delimiter variable">}</span></span> ..."</span><span class="token punctuation">)</span>
                nextPrintTime <span class="token operator">+=</span> <span class="token number">500L</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 等待一段时间</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: I'm tired of waiting!"</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 取消一个任务并且等待它结束</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: Now I can quit."</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sampleEnd</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">15</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">214</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">0</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">649</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">1</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">149</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">2</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">460</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> I'm tired of waiting<span class="token operator">!</span>
<span class="token number">15</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">462</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> Now I can quit<span class="token punctuation">.</span></code></pre>
<p>可以看到，现在循环被取消了。<strong>isActive</strong> 是一个可以被使用在 <strong>CoroutineScope</strong> 中的扩展属性。<br>&nbsp;<br><strong>在 finally 中释放资源</strong></p>
<p>可取消的挂起函数在被取消时会抛出 <strong>CancellationException</strong>，我们通常使用以下方式处理后续的收尾工作。</p>
<ul>
<li><strong>try {……} finally {……}</strong> 表达式<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//sampleStart</span>
      <span class="token keyword">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
                  <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"job: I'm sleeping <span class="token interpolation variable">$i</span> ..."</span><span class="token punctuation">)</span>
                  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500L</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"job: I'm running finally"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 延迟一段时间</span>
      <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main: I'm tired of waiting!"</span><span class="token punctuation">)</span>
      job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 取消该任务并且等待它结束</span>
      <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main: Now I can quit."</span><span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true">//sampleEnd</span>
  <span class="token punctuation">}</span></code></pre>
  运行结果：<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">647</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">0</span> <span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">162</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">1</span> <span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">662</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">2</span> <span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">898</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> I'm tired of waiting<span class="token operator">!</span>
  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">948</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm running <span class="token keyword">finally</span>
  <span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">953</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> Now I can quit<span class="token punctuation">.</span></code></pre>
  &nbsp;</li>
<li>Kotlin 的 <strong>use</strong> 函数<br>  实现了 <strong>Closeable</strong> 接口的对象可调用use函数<br>  <strong>use</strong> 函数会自动关闭调用者（无论中间是否出现异常）<br>  &nbsp;<pre class=" language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@RequireKotlin</span><span class="token punctuation">(</span><span class="token string">"1.2"</span><span class="token punctuation">,</span> versionKind <span class="token operator">=</span> RequireKotlinVersionKind<span class="token punctuation">.</span>COMPILER_VERSION<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">"Requires newer compiler version to be inlined correctly."</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T <span class="token operator">:</span> Closeable<span class="token operator">?</span><span class="token punctuation">,</span> R<span class="token operator">></span> T<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>block<span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R <span class="token punctuation">{</span>
      <span class="token keyword">var</span> exception<span class="token operator">:</span> Throwable<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          exception <span class="token operator">=</span> e
          <span class="token keyword">throw</span> e
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token keyword">when</span> <span class="token punctuation">{</span>
              <span class="token function">apiVersionIsAtLeast</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeFinally</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
              <span class="token keyword">this</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
              exception <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">else</span> <span class="token operator">-></span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                      <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>closeException<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token comment" spellcheck="true">// cause.addSuppressed(closeException) // ignored here</span>
                  <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
  可以看出，<strong>use</strong> 函数内部实现也是通过 <strong>try-catch-finally</strong> 块捕捉的方式。<br>  所以不用担心会有异常抛出导致程序退出，无论是正常结束还是出现异常，都能正确关闭调用者。</li>
</ul>
<p>&nbsp;<br><strong>运行不可取消的代码块</strong></p>
<p>在之前例子中任何尝试在 finally 块中调用<strong>挂起函数</strong>的代码都会抛出 <strong>CancellationException</strong>，因为运行此代码的协程被取消了。</p>
<p>所以良好的关闭操作（关闭一个文件、取消一个任务、或是关闭任何一种 通信通道）通常都是非阻塞的，并且不会调用任何挂起函数。</p>
<p>然而，在真实的案例中，当你需要在一个 <strong>被取消的协程</strong> 中调用挂起函数， 你可以将相应的代码包装在 <strong>withContext(NonCancellable) {……}</strong> 中。</p>
<p>使用 <strong>withContext</strong> 函数以及 <strong>NonCancellable</strong> 上下文，见如下示例所示：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//sampleStart</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"job: I'm sleeping <span class="token interpolation variable">$i</span> ..."</span><span class="token punctuation">)</span>
                <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500L</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">withContext</span><span class="token punctuation">(</span>NonCancellable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"job: I'm running finally"</span><span class="token punctuation">)</span>
                <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//此处调用挂起函数</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"job: And I've just delayed for 1 sec because I'm non-cancellable"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 延迟一段时间</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: I'm tired of waiting!"</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 取消该任务并等待它结束</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"main: Now I can quit."</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sampleEnd</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">683</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">0</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">199</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">1</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">700</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm sleeping <span class="token number">2</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">931</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> I'm tired of waiting<span class="token operator">!</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">990</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span>$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> I'm running <span class="token keyword">finally</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">991</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">2</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$job$<span class="token number">1</span>$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token operator">:</span> job<span class="token operator">:</span> And I<span class="token string">'ve just delayed for 1 sec because I'</span>m non<span class="token operator">-</span>cancellable
<span class="token number">16</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">001</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">:</span> main<span class="token operator">:</span> Now I can quit<span class="token punctuation">.</span></code></pre>
<p>&nbsp;<br><strong>超时取消</strong></p>
<p>在大多数情况下，取消协程的执行是因为它执行的时间超过预期的时间了。<br>虽然，你可以手动获取到协程相应 <strong>Job</strong> 对象的引用，并启动另外一个协程在延迟一段时间后通过 <strong>Job</strong> 对象取消那个协程。<br>然而Kotlin协程库已经为我们准备好 <strong>withTimeout</strong> 函数来做这件事。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//sampleStart</span>
    <span class="token function">withTimeout</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"I'm sleeping <span class="token interpolation variable">$i</span> ..."</span><span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500L</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//sampleEnd</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token number">17</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">826</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> I'm sleeping <span class="token number">0</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">343</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> I'm sleeping <span class="token number">1</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">844</span> <span class="token punctuation">[</span>main <span class="token label symbol">@coroutine</span>#<span class="token number">1</span><span class="token punctuation">]</span> ConsoleExceptionDemoKt$main$<span class="token number">1</span>$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">invokeSuspend</span><span class="token punctuation">(</span>ConsoleExceptionDemo<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> I'm sleeping <span class="token number">2</span> <span class="token operator">..</span><span class="token punctuation">.</span>
Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>TimeoutCancellationException<span class="token operator">:</span> Timed <span class="token keyword">out</span> waiting <span class="token keyword">for</span> <span class="token number">1300</span> ms
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>TimeoutKt<span class="token punctuation">.</span><span class="token function">TimeoutCancellationException</span><span class="token punctuation">(</span>Timeout<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">128</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>TimeoutCoroutine<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Timeout<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">94</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>EventLoopImplBase$DelayedRunnableTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>EventLoop<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">307</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>EventLoopImplBase<span class="token punctuation">.</span><span class="token function">processNextEvent</span><span class="token punctuation">(</span>EventLoop<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">)</span>
    at kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>DefaultExecutor<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>DefaultExecutor<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">745</span><span class="token punctuation">)</span></code></pre>
<p><strong>withTimeout</strong> 抛出的 <strong>TimeoutCancellationException</strong> 是 <strong>CancellationException</strong> 的子类。<br>我们之前没有看到它的堆栈跟踪打印在控制台上。<br>这是因为在取消的协程中，<strong>CancellationException</strong> 被认为是协程完成的正常原因。<br>但是，在这个例子中，我们在main函数中使用了 <strong>withTimeout</strong>。</p>
<p>&nbsp;<br><strong>自定义可取消的挂起函数</strong></p>
<p><strong>delay</strong> 可以响应取消操作，看下 <strong>delay</strong> 函数的实现：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> suspend <span class="token keyword">fun</span> <span class="token function">delay</span><span class="token punctuation">(</span>timeMillis<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeMillis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment" spellcheck="true">// don't delay</span>
    <span class="token keyword">return</span> suspendCancellableCoroutine <span class="token label symbol">sc@</span> <span class="token punctuation">{</span> cont<span class="token operator">:</span> CancellableContinuation<span class="token operator">&lt;</span>Unit<span class="token operator">></span> <span class="token operator">-></span>
        cont<span class="token punctuation">.</span>context<span class="token punctuation">.</span>delay<span class="token punctuation">.</span><span class="token function">scheduleResumeAfterDelay</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">,</span> cont<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>关键部分是其使用 <strong>suspendCancellableCoroutine</strong> 这个挂起内联函数给包装了一下。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">/**
 * Suspends coroutine similar to [suspendCoroutine], but provide an implementation of [CancellableContinuation] to
 * the [block]. This function throws [CancellationException] if the coroutine is cancelled or completed while suspended.
 */</span>
<span class="token keyword">public</span> suspend <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">suspendCancellableCoroutine</span><span class="token punctuation">(</span>
    <span class="token keyword">crossinline</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>CancellableContinuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit
<span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token operator">=</span>
    suspendCoroutineUninterceptedOrReturn <span class="token punctuation">{</span> uCont <span class="token operator">-></span>
        <span class="token keyword">val</span> cancellable <span class="token operator">=</span> <span class="token function">CancellableContinuationImpl</span><span class="token punctuation">(</span>uCont<span class="token punctuation">.</span><span class="token function">intercepted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resumeMode <span class="token operator">=</span> MODE_CANCELLABLE<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// NOTE: Before version 1.1.0 the following invocation was inlined here, so invocation of this</span>
        <span class="token comment" spellcheck="true">// method indicates that the code was compiled by kotlinx.coroutines &lt; 1.1.0</span>
        <span class="token comment" spellcheck="true">// cancellable.initCancellability()</span>
        <span class="token function">block</span><span class="token punctuation">(</span>cancellable<span class="token punctuation">)</span>
        cancellable<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span></code></pre>
<p>包括其他的可取消的挂起函数都是使用 <strong>suspendCancellableCoroutine</strong> 进行了封装。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153319.png" alt></p>
<p>自定义可取消的挂起函数：</p>
<p>使用Retrofit创建一个网络请求接口：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> okhttp3<span class="token punctuation">.</span>OkHttpClient
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>Call
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>gson<span class="token punctuation">.</span>GsonConverterFactory
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>http<span class="token punctuation">.</span>GET
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>http<span class="token punctuation">.</span>Path

<span class="token keyword">val</span> gitHubServiceApi <span class="token keyword">by</span> lazy <span class="token punctuation">{</span>
    <span class="token keyword">val</span> retrofit <span class="token operator">=</span> retrofit2<span class="token punctuation">.</span>Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">"https://api.github.com"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>GitHubServiceApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> GitHubServiceApi <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">"users/{login}"</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span> login<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Call<span class="token operator">&lt;</span>User<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> url<span class="token operator">:</span> String<span class="token punctuation">)</span></code></pre>
<p>&nbsp;<br>普通调用的代码：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> callback <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> Callback<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>call<span class="token operator">:</span> Call<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">,</span> t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"onFailure: <span class="token interpolation variable">$t</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onResponse</span><span class="token punctuation">(</span>call<span class="token operator">:</span> Call<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">,</span> response<span class="token operator">:</span> Response<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"onResponse: <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">HttpException</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    gitHubServiceApi<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">"JakeWharton"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p> 运行结果：</p>
<pre><code>15:28:33:274 [OkHttp https://api.github.com/...] GitHubServiceKt$main$1.onResponse(GitHubService.kt:36): onResponse: 200
15:28:33:292 [OkHttp https://api.github.com/...] GitHubServiceKt$main$1.onResponse(GitHubService.kt:38): User(id=66577, name=Jake Wharton, url=https://api.github.com/users/JakeWharton)</code></pre><p>&nbsp;<br>转换成可取消的挂起函数：</p>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">getUser</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">=</span> suspendCancellableCoroutine<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span> continuation <span class="token operator">-></span>
    <span class="token keyword">val</span> call <span class="token operator">=</span> gitHubServiceApi<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

    continuation<span class="token punctuation">.</span><span class="token function">invokeOnCancellation</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"invokeOnCancellation: cancel the request."</span><span class="token punctuation">)</span>
        call<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> Callback<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>call<span class="token operator">:</span> Call<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">,</span> t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"onFailure: <span class="token interpolation variable">$t</span>"</span><span class="token punctuation">)</span>
            continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onResponse</span><span class="token punctuation">(</span>call<span class="token operator">:</span> Call<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">,</span> response<span class="token operator">:</span> Response<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"onResponse: <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">?:</span> continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span>
                    <span class="token function">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"User is Null"</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span><span class="token function">HttpException</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>&nbsp;<br>在协程中调用并且取消：</p>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> user <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">"JakeWharton"</span><span class="token punctuation">)</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果：</p>
<pre><code>15:53:07:886 [main] ConsoleCancellableKt.main(ConsoleCancellable.kt:15): 2
15:53:07:886 [DefaultDispatcher-worker-1] ConsoleCancellableKt$main$job$1.invokeSuspend(ConsoleCancellable.kt:11): 1
15:53:08:450 [DefaultDispatcher-worker-1] GetUserKt$getUser$2$1.invoke(GetUser.kt:18): invokeOnCancellation: cancel the request.
15:53:08:453 [DefaultDispatcher-worker-1] ConsoleCancellableKt.main(ConsoleCancellable.kt:17): 3
15:53:08:454 [OkHttp https://api.github.com/...] GetUserKt$getUser$2$2.onFailure(GetUser.kt:24): onFailure: java.io.IOException: Canceled</code></pre><p>从日志中看到，取消的回调被调用了，OkHttp 也确实停止了网络请求，并且回调给我们一个 IO 异常，这时候我们的协程已经被取消。</p>
<p>在处于 <strong>取消状态的协程</strong> 上调用 <strong>Continuation.resume</strong> 、 <strong>Continuation.resumeWithException</strong> 或者 <strong>Continuation.resumeWith</strong> 都会被忽略。<br>因此 OkHttp 回调中我们收到 IO 异常后调用的 <strong>continuation.resumeWithException(e)</strong> 不会有任何副作用。<br>&nbsp;<br>Retrofit 2.6.0中使用了协程，也是用了同样的方式。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153318.png" alt></p>
<pre class=" language-kotlin"><code class="language-kotlin">suspend <span class="token keyword">fun</span> <span class="token function">launchForEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    coroutineScope <span class="token punctuation">{</span>
        launch <span class="token punctuation">{</span>
            <span class="token function">listOf</span><span class="token punctuation">(</span><span class="token string">"JakeWharton"</span><span class="token punctuation">,</span> <span class="token string">"abreslav"</span><span class="token punctuation">,</span> <span class="token string">"yole"</span><span class="token punctuation">,</span> <span class="token string">"elizarov"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">val</span> user <span class="token operator">=</span> gitHubServiceApi<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre><code>14:07:31:568 [OkHttp https://api.github.com/...] GitHubServiceKt$gitHubServiceApi$2$retrofit$1.intercept(GitHubService.kt:19): request: 200
14:07:31:587 [main] Demo0Kt$launchForEach$2$1.invokeSuspend(Demo0.kt:16): User(id=66577, name=Jake Wharton, url=https://api.github.com/users/JakeWharton)
14:07:32:931 [OkHttp https://api.github.com/...] GitHubServiceKt$gitHubServiceApi$2$retrofit$1.intercept(GitHubService.kt:19): request: 200
14:07:32:933 [main] Demo0Kt$launchForEach$2$1.invokeSuspend(Demo0.kt:16): User(id=888318, name=Andrey Breslav, url=https://api.github.com/users/abreslav)
14:07:34:285 [OkHttp https://api.github.com/...] GitHubServiceKt$gitHubServiceApi$2$retrofit$1.intercept(GitHubService.kt:19): request: 200
14:07:34:287 [main] Demo0Kt$launchForEach$2$1.invokeSuspend(Demo0.kt:16): User(id=46553, name=Dmitry Jemerov, url=https://api.github.com/users/yole)
14:07:35:626 [OkHttp https://api.github.com/...] GitHubServiceKt$gitHubServiceApi$2$retrofit$1.intercept(GitHubService.kt:19): request: 200
14:07:35:636 [main] Demo0Kt$launchForEach$2$1.invokeSuspend(Demo0.kt:16): User(id=478679, name=Roman Elizarov, url=https://api.github.com/users/elizarov)</code></pre><h3 id="Android中使用协程"><a href="#Android中使用协程" class="headerlink" title="Android中使用协程"></a>Android中使用协程</h3><p><strong>引入协程库</strong></p>
<pre class=" language-gradle"><code class="language-gradle">dependencies {
  implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.2.2'
}</code></pre>
<p><strong>kotlinx-coroutines-android</strong> 依赖的库：<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153315.png" alt><br><strong>kotlinx-coroutines-android</strong> 这个库里面的代码很少，协程的大部分实现都在 <strong>kotlinx-coroutines-core</strong> 这个库里。</p>
<p>&nbsp;<br><strong>任务调度器</strong></p>
<p><strong>kotlinx-coroutines-android</strong> 提供了 <strong>Dispatchers.Main</strong> 调度器 在Android平台上的实现 <strong>HandlerDispatcher</strong>。<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153316.png" alt></p>
<p>可以从源码上看到，任务的调度都是通过 <strong>Handler</strong> 来实现：<br><img src="https://raw.githubusercontent.com/congwiny/BlogPics/master/img/20190829153320.png" alt><br>&nbsp;<br><strong>UI 生命周期作用域</strong></p>
<p>在Android中， 我们想让发出去的请求能够在当前 UI 或者 Activity 退出或者销毁的时候能够自动取消，就要与其生命周期绑定。<br>协程有一个很天然的特性能刚够支持这一点，那就是作用域。官方也提供了 <strong>MainScope</strong> 这个函数。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">/**
 * Creates the main [CoroutineScope] for UI components.
 *
 * Example of use:
 * ```
 * class MyAndroidActivity {
 *   private val scope = MainScope()
 *
 *   override fun onDestroy() {
 *     super.onDestroy()
 *     scope.cancel()
 *   }
 * }
 *
 * ```
 *
 * The resulting scope has [SupervisorJob] and [Dispatchers.Main] context elements.
 * If you want to append additional elements to the main scope, use [CoroutineScope.plus] operator:
 * `val scope = MainScope() + CoroutineName("MyActivity")`.
 */</span>
<span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"FunctionName"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">MainScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CoroutineScope <span class="token operator">=</span> <span class="token function">ContextScope</span><span class="token punctuation">(</span><span class="token function">SupervisorJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span></code></pre>
<p>从 <strong>MainScope</strong> 的源码可以看到，<strong>MainScope</strong> 是由 <strong>SupervisorJob()</strong> 和 <strong>Dispatchers.Main</strong> 共同完成。<br>使用 <strong>SupervisorJob</strong> 保证子任务失败不会导致父任务被取消；父任务能够取消所有的子任务。<br>使用 <strong>Dispatchers.Main</strong> 让协程体运行在主线程中。因此作用域内除非明确声明调度器，协程体都调度在主线程执行。</p>
<p>&nbsp;<br>示例：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mainScope <span class="token operator">=</span> <span class="token function">MainScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>

        button<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//启动一个协程</span>
            mainScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//任务调度在IO线程池</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//模拟耗时操作</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                    <span class="token string">"Hello Coroutines"</span>
                <span class="token punctuation">}</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mainScope<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Activity退出时取消协程</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行结果：</p>
<pre><code>D/Coroutine: [main] MainActivity$onCreate$1$1.invokeSuspend(MainActivity.kt:19): 1
D/Coroutine: [DefaultDispatcher-worker-1] MainActivity$onCreate$1$1$1.invokeSuspend(MainActivity.kt:21): 2
D/Coroutine: [DefaultDispatcher-worker-2] MainActivity$onCreate$1$1$1.invokeSuspend(MainActivity.kt:23): 3
D/Coroutine: [main] MainActivity$onCreate$1$1.invokeSuspend(MainActivity.kt:26): 4</code></pre><p>&nbsp;<br><strong>带有作用域的抽象Activity</strong></p>
<p>尽管我们在上面直接使用 <strong>MainScope</strong> 可以很方便的控制其作用域范围内的协程的取消，<br>以及能够无缝将异步任务切回主线程，这都是我们想要的特性，不过写法上还是不够美观。</p>
<p>官方推荐我们定义一个抽象的 Activity，例如：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">abstract</span> <span class="token keyword">class</span> ScopedActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CoroutineScope <span class="token keyword">by</span> <span class="token function">MainScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这样在 Activity 退出的时候，对应的作用域就会被取消，所有在该 Activity 中发起的请求都会被取消掉。<br>使用时，只需要继承这个抽象类即可：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> CoroutineActivity <span class="token operator">:</span> <span class="token function">ScopedActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>

        button<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//启动一个协程</span>
            launch <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//任务调度在IO线程池</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//模拟耗时操作</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                    <span class="token string">"Hello Coroutines"</span>
                <span class="token punctuation">}</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>除了在当前 Activity 内部获得 <strong>MainScope</strong> 的能力外，还可以将这个 作用域 实例传递给其他需要的模块。</p>
<p>例如 Presenter 通常也需要与 Activity保持同样的生命周期，因此必要时也可以将该作用域传递过去：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> CoroutineActivity <span class="token operator">:</span> <span class="token function">ScopedActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>

        button<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//启动一个协程</span>
            launch <span class="token punctuation">{</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//任务调度在IO线程池</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//模拟耗时操作</span>
                    Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                    <span class="token string">"Hello Coroutines"</span>
                <span class="token punctuation">}</span>
                Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        next<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"Get User Data"</span>
        next<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            <span class="token function">CoroutinePresenter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@CoroutineActivity</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserData</span><span class="token punctuation">(</span>textView<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">CoroutinePresenter</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> scope<span class="token operator">:</span> CoroutineScope<span class="token punctuation">)</span> <span class="token operator">:</span> CoroutineScope <span class="token keyword">by</span> scope <span class="token punctuation">{</span>

    <span class="token keyword">fun</span> <span class="token function">getUserData</span><span class="token punctuation">(</span>textView<span class="token operator">:</span> TextView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        launch <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"Kotlin Coroutines"</span>
        <span class="token punctuation">}</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>多数情况下，Presenter 的方法也会被 Activity 直接调用，因此也可以将 Presenter 的方法生命成 <strong>suspend</strong> 方法，<br>然后用 <strong>coroutineScope</strong> 嵌套作用域，这样 <strong>MainScope</strong> 被取消后，嵌套的子作用域一样也会被取消，进而达到取消全部子协程的目的：</p>
<pre class=" language-kotlin"><code class="language-kotlin">next<span class="token punctuation">.</span><span class="token function">setOnLongClickListener</span> <span class="token punctuation">{</span>
    launch <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span>  <span class="token function">CoroutinePresenter2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"set User data"</span><span class="token punctuation">)</span>
        textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token keyword">data</span>
        textView<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>RED<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> CoroutinePresenter2 <span class="token punctuation">{</span>

    suspend <span class="token keyword">fun</span> <span class="token function">getUserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope<span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"start get user data"</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> deferred <span class="token operator">=</span> <span class="token function">async</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
            Logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"return user data"</span><span class="token punctuation">)</span>
            <span class="token string">"User Data is Empty"</span>
        <span class="token punctuation">}</span>
        deferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>输出log：</p>
<pre><code>D/Coroutine: [main] CoroutinePresenter2$getUserData$2.invokeSuspend(CoroutinePresenter2.kt:9): start get user data
D/Coroutine: [DefaultDispatcher-worker-1] CoroutinePresenter2$getUserData$2$deferred$1.invokeSuspend(CoroutinePresenter2.kt:13): return user data
D/Coroutine: [main] CoroutineActivity$onCreate$3$1.invokeSuspend(CoroutineActivity.kt:42): set User data</code></pre><p>&nbsp;<br>总结：</p>
<p>在 Android 上使用协程，更多的就是简化异步逻辑，把异步的代码改成同步的写法。<br>协程为我们提供了 <strong>Dispatchers.Main</strong> 调度器，让我们的UI 逻辑在 UI 线程中处理。<br>如果涉及到一些 io 操作，使用 <strong>async</strong> 将其调度到 <strong>Dispatchers.IO</strong> 上，结果返回时协程会自动帮我们切回到主线程。<br>对于一些 UI 不相关的逻辑，通常使用 <strong>Dispatchers.Default</strong> 就足够使用了。</p>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Kotlin协程》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2019/08/11/coroutine/" property="cc:attributionName"
               rel="cc:attributionURL">
                congwiny
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '60b3e1e35dbb5cc9317c',
        clientSecret: 'ed5a9996554fc7b77cc00cd5a2077b600f567fb9',
        repo: 'congwiny.github.io',
        owner: 'congwiny',
        admin: "congwiny",
        id: '2019-08-11T22-12-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/08/29/kotlin-yu-java-hun-he-bian-cheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Kotlin与Java混合编程">
                        
                        <span class="card-title">Kotlin与Java混合编程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Kotlin与Java 混合编程Kotlin与Java的类型映射Kotlin 对 Java基本数据类型的映射Kotlin 特殊处理一部分 Java 类型。这样的类型不是“按原样”从 Java 加载，而是 映射 到相应的 Kotlin 类型。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-08-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/kotlin/" target="_blank">
                        <span class="chip bg-color">kotlin</span>
                    </a>
                    
                    <a href="/tags/java/" target="_blank">
                        <span class="chip bg-color">java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="fa fa-dot-circle-o"></i>
            </div>
            <div class="card">
                <a href="/2019/08/11/coroutine/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="Kotlin协程">
                        
                        <span class="card-title">Kotlin协程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            协程（Coroutine）协程引入异步加载图片

普通代码：
  val view = ...
  loadImageAsync(url, callback{
      bitmap ->
      uiThread{
        
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-08-11
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/kotlin/" target="_blank">
                        <span class="chip bg-color">kotlin</span>
                    </a>
                    
                    <a href="/tags/协程/" target="_blank">
                        <span class="chip bg-color">协程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Change<br />'
            + '作者: congwiny<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy;2019 Congwiny.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">22.2k</span>
            
            <br/>
            <span id="sitetime"></span>

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/congwiny" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:congwiny@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 09, 09, 21, 00, 00); //北京时间2019-9-9 21:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<div class="progress-bar"></div>
<link rel="stylesheet" href="/live2d/css/live2d.css" />
<script type="text/javascript" src="/live2d/js/live2d.js"></script>
<script type="text/javascript" src="/live2d/js/message.js"></script>

<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>